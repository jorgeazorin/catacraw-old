"use strict";

module.exports = function (logger) {
    logger('Scraping proxy-listen.de ...');

    const Q = require('q');
    const request = require('request').defaults({jar: true});
    const cheerio = require('cheerio');

    let defer = Q.defer();

    let proxies = [];

    request.get('http://www.proxy-listen.de/Proxy/Proxyliste.html', function (err, res) {
        if (err) throw err;

        let $$ = cheerio.load(res.body);
        let secret = {key: null, value: null};
        secret.key = $$('#proxyform').find('table input[type=hidden]').attr('name');
        secret.value = $$('#proxyform').find('table input[type=hidden]').val();

        let requestOptions = {
            form: {
                'filter_port': '',
                'filter_http_gateway': '',
                'filter_http_anon': '',
                'filter_response_time_http': 10000 / 1000,
                'filter_country': '',
                'filter_timeouts1': '50',
                'liststyle': 'leech',
                'proxies': 300,
                'type': 'httphttps',
                'submit': 'Anzeigen'
            }
        };

        requestOptions['form'][secret.key] = secret.value;

        request.post('http://www.proxy-listen.de/Proxy/Proxyliste.html', requestOptions, function (err, res) {
            if (err) throw err;

            let $ = cheerio.load(res.body);
            $('.proxyListOdd > td > center').find('a').each(function () {
                proxies.push($(this).html());
            });

            defer.resolve(proxies);
        });
    });

    return defer.promise;
};
